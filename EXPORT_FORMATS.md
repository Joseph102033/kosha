# OPS 문서 산출물 포맷 가이드

Safe OPS Studio는 생성된 OPS 문서를 3가지 형식으로 내보내기를 지원합니다.

## 📄 지원 형식

### 1. PDF (Portable Document Format)

**용도**: 프린트 및 공식 문서 보관

**특징**:
- A4 페이지 크기 (595 x 842 points)
- 자동 페이지 분할
- 페이지 번호 자동 추가
- 요약 섹션 + 법령 부록 포함
- 워터마크 및 문서 해시 하단 표기

**기술 스택**:
- `pdf-lib` 라이브러리 사용
- 클라이언트 사이드 생성
- 표준 폰트 사용 (Helvetica, HelveticaBold)

**한글 지원**:
- ⚠️ 제한적 한글 지원: `pdf-lib`의 StandardFonts는 한글 문자를 완벽하게 지원하지 않습니다.
- PDF 하단에 안내 메시지 표시
- 프로덕션 환경에서는 한글 TrueType 폰트(예: Noto Sans KR) 임베딩 권장

**파일명 형식**: `OPS_YYYY-MM-DD-HH-MM_{해시}.pdf`

---

### 2. Markdown (.md)

**용도**: 버전 관리 및 텍스트 편집

**특징**:
- 텍스트 기반 포맷 (Git-friendly)
- GitHub Flavored Markdown 호환
- 체크박스 형식 체크리스트 (`- [ ]`)
- 코드 블록으로 문서 해시 표시
- 가독성 높은 구조

**기술 스택**:
- 순수 JavaScript/TypeScript 문자열 생성
- 클라이언트 사이드 생성
- `file-saver` 라이브러리로 다운로드

**한글 지원**:
- ✅ 완벽한 한글 지원 (UTF-8 인코딩)

**파일명 형식**: `OPS_YYYY-MM-DD-HH-MM_{해시}.md`

**샘플 구조**:
```markdown
# OPS 제목

## 사고 정보
- **발생일시:** 2025-01-15 10:30
- **발생장소:** ...

## 발생개요
...

## 사고 요약
...

## 근본 원인 분석
1. 원인 1
2. 원인 2

## 재발 방지 체크리스트
- [ ] 항목 1
- [ ] 항목 2

---

## 부록: 관련 법령

### 1. 산업안전보건법 제38조
**신뢰도:** ✓ 추천 (95%)
...

---

*Generated by Safe OPS Studio*

**Document Hash:** `a1b2c3d4...`

**Generated:** 2025-01-15 오후 3:45:12
```

---

### 3. Docx (Microsoft Word Document)

**용도**: 한글/MS Word에서 편집 가능

**특징**:
- .docx 형식 (Open XML)
- 한글 워드프로세서 호환
- HWP 스타일 이름 사용 (제목, 제목1, 제목2, 본문)
- 부록 전 페이지 구분 (PageBreak)
- 워터마크 및 문서 해시 하단 표기

**기술 스택**:
- `docx` 라이브러리 사용
- 클라이언트 사이드 생성
- Blob API로 다운로드

**한글 지원**:
- ✅ 완벽한 한글 지원
- 한글 워드프로세서에서 즉시 편집 가능
- MS Word에서도 완벽 호환

**스타일 매핑** (한글 호환):
- 제목 (Title): 문서 제목
- 제목1 (Heading 1): 주요 섹션
- 제목2 (Heading 2): 하위 섹션
- 본문 (Body): 일반 텍스트

**파일명 형식**: `OPS_YYYY-MM-DD-HH-MM_{해시}.docx`

**페이지 구조**:
```
┌─────────────────────┐
│  제목 (중앙 정렬)   │
├─────────────────────┤
│  사고 정보          │
│  - 발생일시: ...    │
│  - 발생장소: ...    │
├─────────────────────┤
│  발생개요           │
│  ...                │
├─────────────────────┤
│  사고 요약          │
│  ...                │
├─────────────────────┤
│  근본 원인 분석     │
│  1. ...             │
│  2. ...             │
├─────────────────────┤
│  재발 방지 체크리스트│
│  ☐ ...              │
│  ☐ ...              │
└─────────────────────┘

┌─────────────────────┐ (새 페이지)
│  부록: 관련 법령    │
├─────────────────────┤
│  1. 법령 제목       │
│     신뢰도: ✓ 추천  │
│     법령 내용...    │
├─────────────────────┤
│  2. 법령 제목       │
│     ...             │
└─────────────────────┘

┌─────────────────────┐
│  ─────────────────  │
│  Generated by ...   │
│  Document Hash: ... │
│  Generated: ...     │
└─────────────────────┘
```

---

## 🔧 사용 방법

### 1. React Component에서 사용

```typescript
import ExportMenu from '@/components/ExportMenu';
import { OPSExportData } from '@/utils/exporters';

const data: OPSExportData = {
  title: '사고 보고서',
  incident_date: '2025-01-15 10:30',
  location: '서울시 강남구...',
  // ... 기타 필드
};

<ExportMenu
  data={data}
  onExportComplete={(format) => {
    console.log(`${format} 내보내기 완료`);
  }}
/>
```

### 2. 직접 호출

```typescript
import {
  downloadPDF,
  downloadMarkdown,
  downloadDocx,
  OPSExportData
} from '@/utils/exporters';

const data: OPSExportData = { /* ... */ };

// PDF 다운로드
await downloadPDF(data, 'my-ops-report.pdf');

// Markdown 다운로드
downloadMarkdown(data, 'my-ops-report.md');

// Docx 다운로드
await downloadDocx(data, 'my-ops-report.docx');
```

### 3. 옵션 설정

```typescript
import { ExportOptions } from '@/utils/exporters';

const options: ExportOptions = {
  includeWatermark: true,  // 워터마크 포함 (기본: true)
  includeHash: true,       // 문서 해시 포함 (기본: true)
  toolName: 'Safe OPS Studio',  // 도구명 (기본: 'Safe OPS Studio')
  appendix: true,          // 법령 부록 포함 (기본: true)
};

await downloadPDF(data, undefined, options);
```

---

## 📊 파일 크기 및 성능

| 형식     | 평균 파일 크기 | 생성 시간 | 브라우저 지원 |
|----------|----------------|-----------|---------------|
| PDF      | 50-150 KB      | ~500ms    | ✅ 모든 브라우저 |
| Markdown | 5-15 KB        | ~10ms     | ✅ 모든 브라우저 |
| Docx     | 20-50 KB       | ~200ms    | ✅ 모든 브라우저 |

*법령 부록 포함 시 기준, 실제 크기는 내용에 따라 다름*

---

## 🔒 보안 및 추적성

모든 산출물에는 다음이 포함됩니다:

1. **워터마크**: 생성 도구명 표시 (`Generated by Safe OPS Studio`)
2. **문서 해시**: SHA-256 해시 (64자) - 문서의 고유 지문
3. **생성 시각**: ISO 8601 형식 타임스탬프

**문서 해시의 용도**:
- 문서의 무결성 검증
- 중복 문서 탐지
- 익명 피드백 시스템의 키
- 위변조 방지

---

## 🧪 테스트

샘플 데이터로 모든 형식 테스트:

1. 개발 서버 실행: `npm run dev`
2. 브라우저에서 `/test-export` 접속
3. 각 형식별 다운로드 버튼 클릭
4. 생성된 파일 확인

**샘플 데이터 위치**: `apps/web/utils/exporters/sample-data.ts`

---

## 🛠️ 기술 상세

### 의존성

```json
{
  "pdf-lib": "^1.17.1",    // PDF 생성
  "docx": "^9.5.1",        // Docx 생성
  "file-saver": "^2.0.5"   // 파일 다운로드
}
```

### 파일 구조

```
apps/web/utils/exporters/
├── types.ts          # 공통 타입 정의
├── pdf.ts            # PDF 생성기
├── markdown.ts       # Markdown 생성기
├── docx.ts           # Docx 생성기
├── sample-data.ts    # 테스트용 샘플 데이터
└── index.ts          # 통합 export

apps/web/components/
└── ExportMenu.tsx    # UI 컴포넌트

apps/web/pages/
└── test-export.tsx   # 테스트 페이지
```

---

## 🚀 프로덕션 개선 사항

### PDF 한글 지원 강화

현재 PDF는 StandardFonts를 사용하여 한글이 제한적으로 표시됩니다. 프로덕션 환경에서는 다음과 같이 개선할 수 있습니다:

```typescript
import { PDFDocument } from 'pdf-lib';
import fontkit from '@pdf-lib/fontkit';

// 한글 폰트 임베딩
const pdfDoc = await PDFDocument.create();
pdfDoc.registerFontkit(fontkit);

const fontBytes = await fetch('/fonts/NotoSansKR-Regular.ttf').then(res => res.arrayBuffer());
const font = await pdfDoc.embedFont(fontBytes);

// 폰트 사용
page.drawText('한글 텍스트', { font });
```

**필요한 작업**:
1. Noto Sans KR 폰트 다운로드 및 `/public/fonts/` 저장
2. `@pdf-lib/fontkit` 패키지 설치
3. `apps/web/utils/exporters/pdf.ts` 수정

### 서버 사이드 생성 (선택사항)

대용량 문서의 경우 Cloudflare Workers에서 생성:

```typescript
// apps/workers/src/ops/export.ts
export async function generateServerPDF(data: OPSExportData): Promise<Uint8Array> {
  // Workers 환경에서 pdf-lib 실행
  // ...
}
```

**장점**:
- 클라이언트 메모리 절약
- 대용량 문서 처리
- 통일된 출력 보장

**단점**:
- Workers 실행 시간 제한
- 추가 비용 발생 가능

---

## 📝 라이센스

이 내보내기 시스템은 Safe OPS Studio 프로젝트의 일부입니다.

사용된 오픈소스 라이브러리:
- pdf-lib: MIT License
- docx: MIT License
- file-saver: MIT License

---

## 🤝 기여

개선 사항 제안:
1. PDF 한글 폰트 임베딩 구현
2. Excel (.xlsx) 형식 추가
3. HTML 미리보기 기능
4. 이메일 첨부 최적화 (압축)

---

**마지막 업데이트**: 2025-01-10
**작성자**: Safe OPS Studio Team
