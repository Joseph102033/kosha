# OPS Illustration System Guide

## 개요

Safe OPS Studio의 사고 형태별 SVG 삽화 생성 시스템입니다. 결정론적(deterministic) 생성을 보장하여 동일한 입력에 대해 항상 동일한 결과를 제공합니다.

## 주요 특징

✅ **100% 결정론적**: 동일 입력 → 동일 SVG 출력
✅ **투명 배경 PNG**: 알파 채널 유지하며 PNG 다운로드
✅ **외부 폰트 불필요**: 시스템 폰트 사용
✅ **자동 텍스트 줄바꿈**: 2줄 이내 자동 처리
✅ **워터마크 포함**: "Generated by Safe OPS Studio"
✅ **일관성 보장 배지**: "✓ 그림 일관성 보장" 표시

## 지원하는 사고 형태

| 사고 형태 | 아이콘 | 키워드 매칭 |
|---------|-------|-----------|
| 추락 | FallIcon | 추락, 낙하 |
| 끼임 | CaughtIcon | 끼임, 협착 |
| 감전 | ElectricIcon | 감전, 전기 |
| 화재 | FireIcon | 화재, 화상 |
| 화학물질 | ChemicalIcon | 화학물질, 누출 |
| 폭발 | ExplosionIcon | 폭발, 파열 |
| 전도/붕괴 | CollapseIcon | 전도, 붕괴, 낙상 |

## 사용 방법

### 1. 기본 사용

```tsx
import Illustration, { IllustrationScenario } from '@/components/ops/Illustration';

const scenario: IllustrationScenario = {
  incidentType: '추락',
  location: '서울시 강남구 건설현장 A동 3층',
  hazardObject: 'A형 사다리',
  agentObject: '작업 발판',
  ppe: ['안전모', '안전벨트', '안전화'],
};

<Illustration
  scenario={scenario}
  width={600}
  height={400}
  showDownloadButton={true}
/>
```

### 2. 최소 구성 (필수 필드만)

```tsx
const scenario: IllustrationScenario = {
  incidentType: '화재',
};

<Illustration scenario={scenario} />
```

### 3. PNG 다운로드 프로그래밍 방식

```tsx
import { exportSvgAsPng } from '@/utils/svg-export';

const svgElement = document.querySelector('svg') as SVGSVGElement;
await exportSvgAsPng(svgElement, 'my-illustration', 800, 800);
```

## API 레퍼런스

### `IllustrationScenario` 인터페이스

```typescript
interface IllustrationScenario {
  incidentType: string;      // 필수: 사고 형태
  location?: string;          // 선택: 발생 장소
  hazardObject?: string;      // 선택: 기인물
  agentObject?: string;       // 선택: 가해물
  ppe?: string[];            // 선택: 필수 보호구 배열
}
```

### `Illustration` Props

```typescript
interface IllustrationProps {
  scenario: IllustrationScenario;  // 필수
  width?: number;                  // 기본값: 600
  height?: number;                 // 기본값: 400
  showDownloadButton?: boolean;    // 기본값: true
}
```

### SVG Export 유틸리티

```typescript
// SVG → PNG 변환
async function svgToPng(
  svgElement: SVGSVGElement,
  width: number = 800,
  height: number = 800
): Promise<Blob>

// SVG → PNG 다운로드
async function exportSvgAsPng(
  svgElement: SVGSVGElement,
  filename: string,
  width?: number,
  height?: number
): Promise<void>

// SVG → Data URL
function svgToDataUrl(svgElement: SVGSVGElement): string

// PNG Blob → Data URL
async function pngBlobToDataUrl(blob: Blob): Promise<string>
```

## 아키텍처

### 파일 구조

```
apps/web/
├── components/ops/
│   ├── Illustration.tsx           # 메인 컴포넌트
│   └── icons/
│       ├── index.ts              # 아이콘 매핑
│       ├── FallIcon.tsx          # 추락
│       ├── CaughtIcon.tsx        # 끼임
│       ├── ElectricIcon.tsx      # 감전
│       ├── FireIcon.tsx          # 화재
│       ├── ChemicalIcon.tsx      # 화학물질
│       ├── ExplosionIcon.tsx     # 폭발
│       └── CollapseIcon.tsx      # 전도/붕괴
├── utils/
│   └── svg-export.ts             # SVG→PNG 변환 유틸
└── pages/
    └── illustration-demo.tsx      # 데모 페이지
```

### 렌더링 흐름

```
1. scenario props 입력
   ↓
2. incidentType으로 아이콘 선택 (ACCIDENT_TYPE_MAP 매핑)
   ↓
3. 텍스트 자동 줄바꿈 (wrapText 함수, 최대 2줄)
   ↓
4. SVG 조립:
   - 배경 (흰색)
   - 아이콘 컴포넌트 (중앙 배치)
   - 상단 라벨 (사고 형태)
   - 좌측 패널 (장소, 기인물, 가해물, 보호구)
   - 워터마크 (하단)
   - 일관성 보장 배지 (우측 상단)
   ↓
5. 인라인 SVG 렌더링
   ↓
6. (선택) PNG 다운로드 버튼 클릭 시:
   - SVG → Canvas → PNG Blob 변환
   - 투명 배경 유지
   - 파일 다운로드
```

## 데모 페이지

데모 페이지를 실행하여 모든 사고 형태별 삽화를 확인할 수 있습니다:

```bash
cd apps/web
npm run dev
```

브라우저에서 `http://localhost:3000/illustration-demo` 접속

## 스냅샷 캡처 가이드

데모 페이지를 사용하여 각 사고 형태별 PNG 스냅샷을 생성하는 방법:

1. **데모 페이지 접속**: `http://localhost:3000/illustration-demo`

2. **각 사고 형태 선택**: 좌측 사이드바에서 7가지 사고 형태를 순차적으로 선택

3. **PNG 다운로드**: 각 삽화의 "📥 PNG로 다운로드 (투명 배경)" 버튼 클릭

4. **파일명 규칙**: `ops_illustration_{사고형태}_{날짜}.png`

### 예상 파일명

- `ops_illustration_추락_2025-01-15.png`
- `ops_illustration_끼임_2025-01-15.png`
- `ops_illustration_감전_2025-01-15.png`
- `ops_illustration_화재_2025-01-15.png`
- `ops_illustration_화학물질_2025-01-15.png`
- `ops_illustration_폭발_2025-01-15.png`
- `ops_illustration_전도_2025-01-15.png`

## 결정론적 생성 보장

시스템이 결정론적 생성을 보장하는 방법:

1. **고정된 SVG 템플릿**: 각 아이콘은 하드코딩된 SVG path 사용
2. **일관된 좌표계**: viewBox="0 0 600 400" 고정
3. **시스템 폰트**: 외부 웹폰트 미사용 (system-ui 폰트 스택)
4. **규칙 기반 텍스트 처리**: 동일한 wrapText 알고리즘
5. **명시적 색상 값**: 하드코딩된 hex 색상 코드
6. **순서 보장**: 동일한 render 순서

### 검증 방법

```tsx
// 동일한 scenario를 두 번 렌더링
const scenario = { incidentType: '추락', location: '건설현장' };

<Illustration scenario={scenario} />
<Illustration scenario={scenario} />

// 두 SVG의 serialized string이 완전히 동일해야 함
```

## 통합 예시 (builder.tsx)

OPS Builder 페이지에서 미리보기로 삽화를 표시하는 예:

```tsx
import Illustration from '@/components/ops/Illustration';

// builder.tsx 내부
const [formData, setFormData] = useState({
  incidentDate: '',
  location: '',
  incidentType: '',
  incidentCause: '',
  // ...
});

// 미리보기 영역
<div className="preview-panel">
  <Illustration
    scenario={{
      incidentType: formData.incidentType,
      location: formData.location,
      hazardObject: extractHazardFromCause(formData.incidentCause),
      ppe: ['안전모', '안전화'], // 사고 형태에 따라 동적 생성 가능
    }}
    width={500}
    height={333}
    showDownloadButton={false}
  />
</div>
```

## 제약사항

1. **텍스트 길이**: 각 필드는 2줄 이내로 자동 줄바꿈
2. **보호구 개수**: 최대 3개까지 표시 (UI 공간 제한)
3. **브라우저 호환성**: Canvas API 지원 필요 (IE11 미지원)
4. **PNG 해상도**: 기본 2배 스케일 (600×400 → 1200×800)

## 문제 해결

### PNG 다운로드 실패

```typescript
// CORS 이슈가 있는 경우 (외부 이미지 로드 시)
// 현재 시스템은 순수 SVG만 사용하므로 CORS 문제 없음
```

### 텍스트가 잘림

```typescript
// wrapText 함수의 maxLength 조정
const lines = wrapText(text, 30); // 기본값 20에서 30으로 증가
```

### 아이콘이 표시되지 않음

```typescript
// ACCIDENT_TYPE_MAP에 매칭되지 않는 경우
// Fuzzy matching으로 fallback 처리됨
// 최종 fallback: FallIcon
```

## 라이센스

이 시스템은 Safe OPS Studio 프로젝트의 일부입니다.
Private project - All rights reserved

---

**Generated by Safe OPS Studio**
*결정론적 안전 사고 삽화 생성 시스템*
